<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•FåŠŸèƒ½é“¾æ¥æ£€æµ‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .debug-section {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .link-test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            background: white;
        }
        .debug-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        .error { color: #f00; }
        .success { color: #0a0; }
        .warning { color: #fa0; }
    </style>
</head>
<body>
    <h1>è°ƒè¯•FåŠŸèƒ½é“¾æ¥æ£€æµ‹</h1>
    
    <div class="debug-section">
        <h2>æµ‹è¯•é“¾æ¥</h2>
        <div class="link-test">
            <a href="https://www.google.com">Googleé“¾æ¥</a>
        </div>
        <div class="link-test">
            <button onclick="alert('æŒ‰é’®ç‚¹å‡»')">æµ‹è¯•æŒ‰é’®</button>
        </div>
        <div class="link-test">
            <input type="button" value="è¾“å…¥æŒ‰é’®" onclick="alert('è¾“å…¥æŒ‰é’®ç‚¹å‡»')">
        </div>
        <div class="link-test">
            <div onclick="alert('å¯ç‚¹å‡»div')" style="cursor: pointer; color: blue; text-decoration: underline;">å¯ç‚¹å‡»çš„DIV</div>
        </div>
        <div class="link-test">
            <span role="button" onclick="alert('è§’è‰²æŒ‰é’®')">è§’è‰²æŒ‰é’®</span>
        </div>
    </div>
    
    <div class="debug-section">
        <h2>è°ƒè¯•æ§åˆ¶</h2>
        <button onclick="debugLinkDetection()">æ£€æµ‹é“¾æ¥</button>
        <button onclick="testHintsCreate()">æµ‹è¯•Hints.create</button>
        <button onclick="checkExtensionStatus()">æ£€æŸ¥æ‰©å±•çŠ¶æ€</button>
        <button onclick="clearDebugOutput()">æ¸…ç©ºè¾“å‡º</button>
    </div>
    
    <div class="debug-section">
        <h2>è°ƒè¯•è¾“å‡º</h2>
        <div id="debug-output" class="debug-output">ç­‰å¾…è°ƒè¯•ä¿¡æ¯...
</div>
    </div>

    <script>
        let debugOutput = document.getElementById('debug-output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            debugOutput.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
        
        function clearDebugOutput() {
            debugOutput.innerHTML = 'è°ƒè¯•è¾“å‡ºå·²æ¸…ç©º\n';
        }
        
        function checkExtensionStatus() {
            log('=== æ£€æŸ¥æ‰©å±•çŠ¶æ€ ===');
            
            // æ£€æŸ¥å…¨å±€å¯¹è±¡
            const globals = ['Hints', 'Command', 'DOM', 'mapDOM', 'settings'];
            globals.forEach(name => {
                if (typeof window[name] !== 'undefined') {
                    log(`âœ… ${name} å·²å®šä¹‰`, 'success');
                } else {
                    log(`âŒ ${name} æœªå®šä¹‰`, 'error');
                }
            });
            
            // æ£€æŸ¥Hintså¯¹è±¡çš„æ–¹æ³•
            if (typeof window.Hints !== 'undefined') {
                const hintsMethods = ['create', 'getLinks', 'getLinkInfo', 'getLinkType', 'isVisible'];
                hintsMethods.forEach(method => {
                    if (typeof window.Hints[method] === 'function') {
                        log(`âœ… Hints.${method} æ–¹æ³•å­˜åœ¨`, 'success');
                    } else {
                        log(`âŒ Hints.${method} æ–¹æ³•ä¸å­˜åœ¨`, 'error');
                    }
                });
            }
            
            // æ£€æŸ¥DOMå¯¹è±¡çš„æ–¹æ³•
            if (typeof window.DOM !== 'undefined') {
                const domMethods = ['isVisible', 'getVisibleBoundingRect'];
                domMethods.forEach(method => {
                    if (typeof window.DOM[method] === 'function') {
                        log(`âœ… DOM.${method} æ–¹æ³•å­˜åœ¨`, 'success');
                    } else {
                        log(`âŒ DOM.${method} æ–¹æ³•ä¸å­˜åœ¨`, 'error');
                    }
                });
            }
        }
        
        function debugLinkDetection() {
            log('=== å¼€å§‹é“¾æ¥æ£€æµ‹è°ƒè¯• ===');
            
            if (typeof window.mapDOM === 'undefined') {
                log('âŒ mapDOMå‡½æ•°æœªå®šä¹‰', 'error');
                return;
            }
            
            if (typeof window.Hints === 'undefined') {
                log('âŒ Hintså¯¹è±¡æœªå®šä¹‰', 'error');
                return;
            }
            
            try {
                // æ‰‹åŠ¨åˆ›å»ºhintFilter
                if (typeof window.Hints.createHintFilter === 'function') {
                    window.Hints.hintFilter = window.Hints.createHintFilter(document.URL);
                    log('âœ… åˆ›å»ºäº†hintFilter', 'success');
                } else {
                    log('âŒ Hints.createHintFilteræ–¹æ³•ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                // æ¸…é™¤ç¼“å­˜
                if (typeof window.Hints.getLinkInfo.clearCache === 'function') {
                    window.Hints.getLinkInfo.clearCache();
                    log('âœ… æ¸…é™¤äº†getLinkInfoç¼“å­˜', 'success');
                }
                
                // ä½¿ç”¨mapDOMæ£€æµ‹é“¾æ¥
                const links = window.mapDOM(document.body, window.Hints.getLinkInfo);
                log(`ğŸ” æ£€æµ‹åˆ° ${links.length} ä¸ªé“¾æ¥`, links.length > 0 ? 'success' : 'warning');
                
                // è¯¦ç»†åˆ†ææ¯ä¸ªé“¾æ¥
                links.forEach((link, index) => {
                    if (link && link.node) {
                        const tagName = link.node.tagName.toLowerCase();
                        const text = link.node.textContent.trim().substring(0, 50);
                        const rect = link.rect;
                        log(`  é“¾æ¥ ${index + 1}: <${tagName}> "${text}" (${rect.width}x${rect.height})`);
                    }
                });
                
                // æ‰‹åŠ¨æ£€æŸ¥é¡µé¢ä¸­çš„æ‰€æœ‰é“¾æ¥å…ƒç´ 
                log('\n=== æ‰‹åŠ¨æ£€æŸ¥é¡µé¢å…ƒç´  ===');
                const allLinks = document.querySelectorAll('a, button, input[type="button"], [onclick], [role="button"]');
                log(`ğŸ“‹ é¡µé¢ä¸­å…±æœ‰ ${allLinks.length} ä¸ªæ½œåœ¨å¯ç‚¹å‡»å…ƒç´ `);
                
                Array.from(allLinks).forEach((element, index) => {
                    const tagName = element.tagName.toLowerCase();
                    const text = element.textContent.trim().substring(0, 30);
                    const isVisible = window.DOM ? window.DOM.isVisible(element) : 'DOMæœªå®šä¹‰';
                    const rect = element.getBoundingClientRect();
                    const linkType = window.Hints.getLinkType ? window.Hints.getLinkType(element) : 'getLinkTypeæœªå®šä¹‰';
                    
                    log(`  å…ƒç´  ${index + 1}: <${tagName}> "${text}" å¯è§:${isVisible} ç±»å‹:${linkType} ä½ç½®:(${rect.left},${rect.top}) å¤§å°:${rect.width}x${rect.height}`);
                });
                
            } catch (error) {
                log(`âŒ é“¾æ¥æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error');
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }
        
        function testHintsCreate() {
            log('=== æµ‹è¯•Hints.create ===');
            
            if (typeof window.Hints === 'undefined') {
                log('âŒ Hintså¯¹è±¡æœªå®šä¹‰', 'error');
                return;
            }
            
            if (typeof window.Hints.create !== 'function') {
                log('âŒ Hints.createæ–¹æ³•ä¸å­˜åœ¨', 'error');
                return;
            }
            
            try {
                log('ğŸš€ è°ƒç”¨Hints.create()...');
                window.Hints.create();
                
                // æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†æç¤ºå®¹å™¨
                setTimeout(() => {
                    const container = document.getElementById('rVim-link-container');
                    if (container) {
                        log('âœ… æˆåŠŸåˆ›å»ºäº†rVim-link-container', 'success');
                        const hints = container.querySelectorAll('.rVim-link-hint');
                        log(`ğŸ“ åˆ›å»ºäº† ${hints.length} ä¸ªé“¾æ¥æç¤º`, hints.length > 0 ? 'success' : 'warning');
                        
                        // æ˜¾ç¤ºæç¤ºçš„è¯¦ç»†ä¿¡æ¯
                        hints.forEach((hint, index) => {
                            const style = hint.style;
                            log(`  æç¤º ${index + 1}: ä½ç½®(${style.left}, ${style.top}) å†…å®¹:"${hint.textContent}"`);
                        });
                    } else {
                        log('âŒ æœªæ‰¾åˆ°rVim-link-container', 'error');
                    }
                }, 100);
                
            } catch (error) {
                log(`âŒ Hints.createè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥æ‰©å±•çŠ¶æ€
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥æ‰©å±•çŠ¶æ€...');
                checkExtensionStatus();
            }, 1000);
        });
        
        // ç›‘å¬Fé”®
        document.addEventListener('keydown', function(e) {
            if (e.key === 'f' || e.key === 'F') {
                log(`\n=== æ£€æµ‹åˆ°Fé”®æŒ‰ä¸‹ ===`);
                setTimeout(() => {
                    const container = document.getElementById('rVim-link-container');
                    if (container) {
                        log('âœ… Fé”®è§¦å‘åå‘ç°äº†rVim-link-container', 'success');
                    } else {
                        log('âŒ Fé”®è§¦å‘åæœªå‘ç°rVim-link-container', 'error');
                    }
                }, 100);
            }
        });
    </script>
</body>
</html>