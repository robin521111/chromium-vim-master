<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rVim æ‰©å±•æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #test-results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .vim-test-area {
            height: 200px;
            background: #fff;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 18px;
            color: #666;
        }
        .instructions {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .manual-tests {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ rVim Chrome æ‰©å±•æµ‹è¯•é¡µé¢</h1>
        
        <div class="instructions">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯• rVim Chrome æ‰©å±•çš„å„é¡¹åŠŸèƒ½ã€‚è¯·ç¡®ä¿ï¼š</p>
            <ul>
                <li>å·²åœ¨ Chrome å¼€å‘è€…æ¨¡å¼ä¸‹åŠ è½½ rVim æ‰©å±•</li>
                <li>æ‰©å±•å·²å¯ç”¨ä¸”æƒé™å·²æˆäºˆ</li>
                <li>é¡µé¢å·²åˆ·æ–°ä»¥ç¡®ä¿å†…å®¹è„šæœ¬æ­£ç¡®æ³¨å…¥</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ¤– è‡ªåŠ¨åŒ–æµ‹è¯•</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼š</p>
            <button class="test-button" onclick="runAutomatedTests()">è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•</button>
            <button class="test-button" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
            <div id="test-results"></div>
        </div>

        <div class="manual-tests">
            <h3>âœ‹ æ‰‹åŠ¨æµ‹è¯•é¡¹ç›®</h3>
            <p>è¯·æ‰‹åŠ¨éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
            <ol>
                <li><strong>æ‰©å±•å›¾æ ‡</strong>ï¼šæ£€æŸ¥æµè§ˆå™¨å·¥å…·æ æ˜¯å¦æ˜¾ç¤º rVim å›¾æ ‡</li>
                <li><strong>å¼¹å‡ºçª—å£</strong>ï¼šç‚¹å‡»å›¾æ ‡æŸ¥çœ‹å¼¹å‡ºçª—å£</li>
                <li><strong>é€‰é¡¹é¡µé¢</strong>ï¼šå³é”®å›¾æ ‡ â†’ é€‰é¡¹</li>
                <li><strong>Service Worker</strong>ï¼šchrome://extensions/ â†’ rVim â†’ Service Worker</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>âŒ¨ï¸ Vim é”®ç›˜æ“ä½œæµ‹è¯•åŒºåŸŸ</h3>
            <p>åœ¨ä¸‹æ–¹åŒºåŸŸæµ‹è¯• Vim é”®ç›˜æ“ä½œï¼š</p>
            <div class="vim-test-area" id="vim-test-area">
                ä½¿ç”¨ j/k é”®ä¸Šä¸‹æ»šåŠ¨ï¼Œh/l é”®å·¦å³æ»šåŠ¨<br>
                æŒ‰ f é”®è¿›å…¥é“¾æ¥æç¤ºæ¨¡å¼<br>
                æŒ‰ / é”®è¿›å…¥æœç´¢æ¨¡å¼
            </div>
            
            <h4>ğŸ”— æµ‹è¯•é“¾æ¥</h4>
            <p>ä½¿ç”¨ f é”®æµ‹è¯•é“¾æ¥æç¤ºåŠŸèƒ½ï¼š</p>
            <a href="#test1">æµ‹è¯•é“¾æ¥ 1</a> |
            <a href="#test2">æµ‹è¯•é“¾æ¥ 2</a> |
            <a href="#test3">æµ‹è¯•é“¾æ¥ 3</a> |
            <a href="https://www.google.com" target="_blank" rel="noopener">Google</a>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•çŠ¶æ€</h3>
            <div id="test-status">
                <div>æ‰©å±•åŠ è½½çŠ¶æ€ï¼š<span class="status" id="extension-status">æœªæµ‹è¯•</span></div>
                <div>Service Workerï¼š<span class="status" id="sw-status">æœªæµ‹è¯•</span></div>
                <div>å†…å®¹è„šæœ¬ï¼š<span class="status" id="content-status">æœªæµ‹è¯•</span></div>
                <div>Vim åŠŸèƒ½ï¼š<span class="status" id="vim-status">æœªæµ‹è¯•</span></div>
            </div>
        </div>
    </div>

    <script src="chrome_test_automation.js"></script>
    <script>
        let testOutput = document.getElementById('test-results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testOutput.textContent += `[${timestamp}] ${message}\n`;
            testOutput.scrollTop = testOutput.scrollHeight;
        }
        
        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = text;
        }
        
        async function runAutomatedTests() {
            testOutput.textContent = '';
            log('ğŸš€ å¼€å§‹ rVim æ‰©å±•è‡ªåŠ¨åŒ–æµ‹è¯•...');
            log('=' .repeat(50));
            
            try {
                // æ£€æŸ¥æ‰©å±•æ˜¯å¦åŠ è½½
                log('ğŸ” æ£€æŸ¥æ‰©å±•åŠ è½½çŠ¶æ€...');
                if (typeof chrome !== 'undefined' && chrome.management) {
                    chrome.management.getAll((extensions) => {
                        const rVimExt = extensions.find(ext => ext.name === 'rVim');
                        if (rVimExt && rVimExt.enabled) {
                            log('âœ… rVim æ‰©å±•å·²åŠ è½½å¹¶å¯ç”¨');
                            log(`   æ‰©å±•ID: ${rVimExt.id}`);
                            log(`   ç‰ˆæœ¬: ${rVimExt.version}`);
                            updateStatus('extension-status', 'success', 'å·²åŠ è½½');
                        } else {
                            log('âŒ rVim æ‰©å±•æœªæ‰¾åˆ°æˆ–æœªå¯ç”¨');
                            updateStatus('extension-status', 'error', 'æœªåŠ è½½');
                        }
                    });
                } else {
                    log('âš ï¸ æ— æ³•è®¿é—® chrome.management API');
                    updateStatus('extension-status', 'warning', 'æ— æ³•æ£€æµ‹');
                }
                
                // æ£€æŸ¥å†…å®¹è„šæœ¬
                log('\nğŸ” æ£€æŸ¥å†…å®¹è„šæœ¬æ³¨å…¥...');
                const hasrVimElements = document.querySelector('.rVim-hud') || 
                                       document.querySelector('#rVim-command-line') ||
                                       window.rVim !== undefined;
                
                if (hasrVimElements || window.rVim) {
                    log('âœ… å†…å®¹è„šæœ¬å·²æˆåŠŸæ³¨å…¥');
                    updateStatus('content-status', 'success', 'å·²æ³¨å…¥');
                } else {
                    log('âš ï¸ å†…å®¹è„šæœ¬å¯èƒ½æœªæ³¨å…¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    updateStatus('content-status', 'warning', 'æœªæ£€æµ‹åˆ°');
                }
                
                // æµ‹è¯• Vim é”®ç›˜åŠŸèƒ½
                log('\nğŸ§ª æµ‹è¯• Vim é”®ç›˜åŠŸèƒ½...');
                const originalScrollY = window.scrollY;
                
                // æ¨¡æ‹ŸæŒ‰ä¸‹ 'j' é”®
                const keyEvent = new KeyboardEvent('keydown', {
                    key: 'j',
                    code: 'KeyJ',
                    keyCode: 74,
                    which: 74,
                    bubbles: true,
                    cancelable: true
                });
                
                document.dispatchEvent(keyEvent);
                
                setTimeout(() => {
                    if (window.scrollY !== originalScrollY || window.rVim) {
                        log('âœ… Vim é”®ç›˜åŠŸèƒ½å“åº”æ­£å¸¸');
                        updateStatus('vim-status', 'success', 'æ­£å¸¸å·¥ä½œ');
                    } else {
                        log('âš ï¸ Vim é”®ç›˜åŠŸèƒ½å¯èƒ½æœªæ¿€æ´»');
                        updateStatus('vim-status', 'warning', 'æœªå“åº”');
                    }
                    
                    log('\nğŸ“Š è‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆ');
                    log('ğŸ’¡ è¯·ç»§ç»­è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•éªŒè¯');
                }, 1000);
                
            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
            }
        }
        
        function clearResults() {
            testOutput.textContent = '';
            // é‡ç½®çŠ¶æ€
            updateStatus('extension-status', '', 'æœªæµ‹è¯•');
            updateStatus('sw-status', '', 'æœªæµ‹è¯•');
            updateStatus('content-status', '', 'æœªæµ‹è¯•');
            updateStatus('vim-status', '', 'æœªæµ‹è¯•');
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹æ£€æŸ¥
        window.addEventListener('load', () => {
            log('ğŸ“„ æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ğŸ’¡ ç‚¹å‡»"è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
        
        // ç›‘å¬é”®ç›˜äº‹ä»¶ä»¥æ£€æµ‹ rVim åŠŸèƒ½
        document.addEventListener('keydown', (e) => {
            if (e.key === 'j' || e.key === 'k' || e.key === 'h' || e.key === 'l') {
                log(`âŒ¨ï¸ æ£€æµ‹åˆ° Vim é”®ç›˜æ“ä½œ: ${e.key}`);
            }
        });
    </script>
</body>
</html>