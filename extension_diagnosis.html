<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰©å±•è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            border: 1px solid #ddd;
            margin: 15px 0;
            border-radius: 5px;
            overflow: hidden;
        }
        .section-header {
            background: #007bff;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }
        .section-header:hover {
            background: #0056b3;
        }
        .section-content {
            padding: 15px;
            background: #f8f9fa;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: 500;
        }
        .status-value {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .test-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .test-link {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .test-link:hover {
            background: #0056b3;
        }
        .console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 4px;
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .hint-container {
            position: relative;
            min-height: 100px;
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Chromium Vim æ‰©å±•è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨äºè¯Šæ–­FåŠŸèƒ½é“¾æ¥æç¤ºæ— æ³•æ˜¾ç¤ºçš„é—®é¢˜</p>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection('extension-status')">
                ğŸ“‹ æ‰©å±•çŠ¶æ€æ£€æŸ¥
            </div>
            <div class="section-content" id="extension-status">
                <div id="extension-status-content">
                    <div class="status-item">
                        <span class="status-label">æ­£åœ¨æ£€æŸ¥æ‰©å±•çŠ¶æ€...</span>
                        <span class="status-value status-info">æ£€æŸ¥ä¸­</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection('script-injection')">
                ğŸ’‰ è„šæœ¬æ³¨å…¥æ£€æŸ¥
            </div>
            <div class="section-content" id="script-injection">
                <div id="script-injection-content">
                    <div class="status-item">
                        <span class="status-label">æ­£åœ¨æ£€æŸ¥è„šæœ¬æ³¨å…¥...</span>
                        <span class="status-value status-info">æ£€æŸ¥ä¸­</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection('event-listeners')">
                ğŸ¯ äº‹ä»¶ç›‘å¬æ£€æŸ¥
            </div>
            <div class="section-content" id="event-listeners">
                <div id="event-listeners-content">
                    <div class="status-item">
                        <span class="status-label">æ­£åœ¨æ£€æŸ¥äº‹ä»¶ç›‘å¬...</span>
                        <span class="status-value status-info">æ£€æŸ¥ä¸­</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection('test-area')">
                ğŸ§ª æµ‹è¯•åŒºåŸŸ
            </div>
            <div class="section-content" id="test-area">
                <div class="test-links">
                    <a href="#test1" class="test-link">æµ‹è¯•é“¾æ¥ 1</a>
                    <a href="#test2" class="test-link">æµ‹è¯•é“¾æ¥ 2</a>
                    <button class="test-link">æµ‹è¯•æŒ‰é’® 1</button>
                    <button class="test-link" onclick="alert('æŒ‰é’®ç‚¹å‡»')">æµ‹è¯•æŒ‰é’® 2</button>
                    <input type="button" value="è¾“å…¥æŒ‰é’®" class="test-link">
                    <div class="test-link" onclick="alert('DIVç‚¹å‡»')" style="display: inline-block;">å¯ç‚¹å‡»DIV</div>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="manualTestF()">æ‰‹åŠ¨æµ‹è¯•Fé”®</button>
                    <button class="btn btn-success" onclick="testHintsCreate()">æµ‹è¯•Hints.create</button>
                    <button class="btn btn-warning" onclick="testLinkDetection()">æµ‹è¯•é“¾æ¥æ£€æµ‹</button>
                    <button class="btn btn-danger" onclick="clearHints()">æ¸…é™¤æç¤º</button>
                </div>
                
                <div class="hint-container" id="hint-test-area">
                    æŒ‰Fé”®æˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æµ‹è¯•é“¾æ¥æç¤ºåŠŸèƒ½
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection('console-log')">
                ğŸ“ æ§åˆ¶å°æ—¥å¿—
            </div>
            <div class="section-content" id="console-log">
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="clearConsole()">æ¸…ç©ºæ—¥å¿—</button>
                    <button class="btn btn-success" onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
                </div>
                <div class="console-output" id="console-output">
æ‰©å±•è¯Šæ–­å·¥å…·å·²å¯åŠ¨...
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let consoleOutput = document.getElementById('console-output');
        let diagnosticResults = {};
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        function clearConsole() {
            consoleOutput.textContent = 'æ§åˆ¶å°å·²æ¸…ç©º\n';
        }
        
        function exportLog() {
            const logContent = consoleOutput.textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rvim-diagnosis-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }
        
        function updateStatus(containerId, items) {
            const container = document.getElementById(containerId + '-content');
            container.innerHTML = '';
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'status-item';
                div.innerHTML = `
                    <span class="status-label">${item.label}</span>
                    <span class="status-value status-${item.status}">${item.value}</span>
                `;
                container.appendChild(div);
            });
        }
        
        function checkExtensionStatus() {
            log('å¼€å§‹æ£€æŸ¥æ‰©å±•çŠ¶æ€...');
            
            const checks = [];
            
            // æ£€æŸ¥å…¨å±€å¯¹è±¡
            const globalObjects = ['Hints', 'Command', 'DOM', 'mapDOM', 'settings', 'Mappings'];
            globalObjects.forEach(name => {
                const exists = typeof window[name] !== 'undefined';
                checks.push({
                    label: `å…¨å±€å¯¹è±¡ ${name}`,
                    status: exists ? 'success' : 'error',
                    value: exists ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰'
                });
                log(`${name}: ${exists ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰'}`, exists ? 'success' : 'error');
            });
            
            // æ£€æŸ¥Hintså¯¹è±¡çš„æ–¹æ³•
            if (typeof window.Hints !== 'undefined') {
                const hintsMethods = ['create', 'getLinks', 'getLinkInfo', 'getLinkType', 'isVisible', 'hideHints'];
                hintsMethods.forEach(method => {
                    const exists = typeof window.Hints[method] === 'function';
                    checks.push({
                        label: `Hints.${method}`,
                        status: exists ? 'success' : 'error',
                        value: exists ? 'å­˜åœ¨' : 'ç¼ºå¤±'
                    });
                    log(`Hints.${method}: ${exists ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, exists ? 'success' : 'error');
                });
            }
            
            // æ£€æŸ¥DOMå¯¹è±¡çš„æ–¹æ³•
            if (typeof window.DOM !== 'undefined') {
                const domMethods = ['isVisible', 'getVisibleBoundingRect', 'mouseEvent'];
                domMethods.forEach(method => {
                    const exists = typeof window.DOM[method] === 'function';
                    checks.push({
                        label: `DOM.${method}`,
                        status: exists ? 'success' : 'error',
                        value: exists ? 'å­˜åœ¨' : 'ç¼ºå¤±'
                    });
                    log(`DOM.${method}: ${exists ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, exists ? 'success' : 'error');
                });
            }
            
            updateStatus('extension-status', checks);
            diagnosticResults.extensionStatus = checks;
        }
        
        function checkScriptInjection() {
            log('å¼€å§‹æ£€æŸ¥è„šæœ¬æ³¨å…¥...');
            
            const checks = [];
            
            // æ£€æŸ¥content scripts
            const scripts = document.querySelectorAll('script');
            let rvimScripts = 0;
            scripts.forEach(script => {
                if (script.src && (script.src.includes('content_scripts') || script.src.includes('rvim'))) {
                    rvimScripts++;
                }
            });
            
            checks.push({
                label: 'Content Scriptsæ•°é‡',
                status: rvimScripts > 0 ? 'success' : 'warning',
                    value: rvimScripts.toString()
            });
            
            // æ£€æŸ¥CSSæ³¨å…¥
            const styles = document.querySelectorAll('style, link[rel="stylesheet"]');
            let rvimStyles = 0;
            styles.forEach(style => {
                const content = style.textContent || style.href || '';
                if (content.includes('rVim')) {
                    rvimStyles++;
                }
            });
            
            checks.push({
                label: 'CSSæ ·å¼æ³¨å…¥',
                status: rvimStyles > 0 ? 'success' : 'warning',
                    value: rvimStyles > 0 ? 'å·²æ³¨å…¥' : 'æœªæ£€æµ‹åˆ°'
            });
            
            // æ£€æŸ¥DOMå…ƒç´ 
            const rVimElements = document.querySelectorAll('[class*="rVim"], [id*="rVim"]');
            checks.push({
                label: 'rVim DOMå…ƒç´ ',
                status: rVimElements.length > 0 ? 'success' : 'info',
                value: rVimElements.length.toString()
            });
            
            updateStatus('script-injection', checks);
            diagnosticResults.scriptInjection = checks;
            
            log(`æ£€æµ‹åˆ° ${rvimScripts} ä¸ªç›¸å…³è„šæœ¬, ${rvimStyles} ä¸ªæ ·å¼, ${rVimElements.length} ä¸ªDOMå…ƒç´ `);
        }
        
        function checkEventListeners() {
            log('å¼€å§‹æ£€æŸ¥äº‹ä»¶ç›‘å¬...');
            
            const checks = [];
            
            // æ£€æŸ¥é”®ç›˜äº‹ä»¶ç›‘å¬
            let hasKeydownListener = false;
            try {
                // å°è¯•è§¦å‘ä¸€ä¸ªæµ‹è¯•äº‹ä»¶
                const testEvent = new KeyboardEvent('keydown', { key: 'f' });
                document.dispatchEvent(testEvent);
                hasKeydownListener = true;
            } catch (e) {
                log(`äº‹ä»¶æµ‹è¯•å¤±è´¥: ${e.message}`, 'error');
            }
            
            checks.push({
                label: 'é”®ç›˜äº‹ä»¶ç›‘å¬',
                status: hasKeydownListener ? 'success' : 'warning',
                value: hasKeydownListener ? 'æ­£å¸¸' : 'æœªçŸ¥'
            });
            
            // æ£€æŸ¥Commandå¯¹è±¡çš„çŠ¶æ€
            if (typeof window.Command !== 'undefined') {
                checks.push({
                    label: 'Commandå¯¹è±¡çŠ¶æ€',
                    status: 'success',
                    value: 'å·²åˆå§‹åŒ–'
                });
                
                if (window.Command.mode) {
                    checks.push({
                        label: 'å½“å‰æ¨¡å¼',
                        status: 'info',
                        value: window.Command.mode
                    });
                }
            }
            
            updateStatus('event-listeners', checks);
            diagnosticResults.eventListeners = checks;
        }
        
        function manualTestF() {
            log('æ‰‹åŠ¨æµ‹è¯•Fé”®åŠŸèƒ½...');
            
            if (typeof window.Hints === 'undefined') {
                log('Hintså¯¹è±¡æœªå®šä¹‰ï¼Œæ— æ³•æµ‹è¯•', 'error');
                return;
            }
            
            try {
                log('è°ƒç”¨Hints.create()...');
                window.Hints.create();
                
                setTimeout(() => {
                    const container = document.getElementById('rVim-link-container');
                    if (container) {
                        log('âœ… æˆåŠŸåˆ›å»ºé“¾æ¥æç¤ºå®¹å™¨', 'success');
                        const hints = container.querySelectorAll('.rVim-link-hint');
                        log(`åˆ›å»ºäº† ${hints.length} ä¸ªé“¾æ¥æç¤º`, hints.length > 0 ? 'success' : 'warning');
                    } else {
                        log('âŒ æœªæ‰¾åˆ°é“¾æ¥æç¤ºå®¹å™¨', 'error');
                    }
                }, 200);
                
            } catch (error) {
                log(`Fé”®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }
        
        function testHintsCreate() {
            log('æµ‹è¯•Hints.createå‡½æ•°...');
            manualTestF();
        }
        
        function testLinkDetection() {
            log('æµ‹è¯•é“¾æ¥æ£€æµ‹åŠŸèƒ½...');
            
            if (typeof window.mapDOM === 'undefined' || typeof window.Hints === 'undefined') {
                log('ç¼ºå°‘å¿…è¦çš„å‡½æ•°ï¼Œæ— æ³•æµ‹è¯•é“¾æ¥æ£€æµ‹', 'error');
                return;
            }
            
            try {
                const links = window.mapDOM(document.body, window.Hints.getLinkInfo);
                log(`æ£€æµ‹åˆ° ${links.length} ä¸ªé“¾æ¥`, links.length > 0 ? 'success' : 'warning');
                
                links.slice(0, 5).forEach((link, index) => {
                    if (link && link.node) {
                        const tagName = link.node.tagName.toLowerCase();
                        const text = link.node.textContent.trim().substring(0, 30);
                        log(`  é“¾æ¥ ${index + 1}: <${tagName}> "${text}"`);
                    }
                });
                
            } catch (error) {
                log(`é“¾æ¥æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function clearHints() {
            log('æ¸…é™¤æ‰€æœ‰é“¾æ¥æç¤º...');
            
            const containers = document.querySelectorAll('#rVim-link-container, .rVim-link-hint');
            containers.forEach(container => container.remove());
            
            if (typeof window.Hints !== 'undefined' && window.Hints.hideHints) {
                try {
                    window.Hints.hideHints();
                    log('è°ƒç”¨Hints.hideHints()æˆåŠŸ', 'success');
                } catch (error) {
                    log(`è°ƒç”¨Hints.hideHints()å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            log('é“¾æ¥æç¤ºå·²æ¸…é™¤', 'success');
        }
        
        // ç›‘å¬Fé”®
        document.addEventListener('keydown', function(e) {
            if (e.key === 'f' || e.key === 'F') {
                log(`æ£€æµ‹åˆ°Fé”®æŒ‰ä¸‹ (key: ${e.key}, code: ${e.code})`);
                
                setTimeout(() => {
                    const container = document.getElementById('rVim-link-container');
                    if (container) {
                        log('Fé”®è§¦å‘åå‘ç°äº†é“¾æ¥æç¤ºå®¹å™¨', 'success');
                    } else {
                        log('Fé”®è§¦å‘åæœªå‘ç°é“¾æ¥æç¤ºå®¹å™¨', 'warning');
                    }
                }, 100);
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨è¯Šæ–­...');
                checkExtensionStatus();
                checkScriptInjection();
                checkEventListeners();
                log('è‡ªåŠ¨è¯Šæ–­å®Œæˆ');
            }, 1000);
        });
        
        // å®šæœŸæ£€æŸ¥æ‰©å±•çŠ¶æ€
        setInterval(() => {
            const container = document.getElementById('rVim-link-container');
            if (container && !container.dataset.logged) {
                log('å‘ç°æ–°çš„é“¾æ¥æç¤ºå®¹å™¨', 'success');
                container.dataset.logged = 'true';
            }
        }, 1000);
    </script>
</body>
</html>